<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control AK: Minimal Discipline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        :root {
            --bg-deep: #050505;
            --ak-green: #22c55e;
            --ak-purple: #a855f7;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: #e5e7eb;
            letter-spacing: -0.01em;
        }

        .soft-glass {
            background: rgba(18, 18, 18, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 2rem;
        }

        .sidebar-item {
            border-radius: 1.25rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-item.active {
            background: rgba(34, 197, 94, 0.1);
            color: var(--ak-green);
        }

        .btn-primary {
            background: var(--ak-green);
            color: #000;
            border-radius: 1.25rem;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(34, 197, 94, 0.3);
            filter: brightness(1.1);
        }

        .card-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.5rem;
            transition: all 0.2s ease;
        }

        input, textarea {
            background: rgba(255, 255, 255, 0.03) !important;
            border-radius: 1rem !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
        }

        input:focus, textarea:focus {
            border-color: var(--ak-green) !important;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1) !important;
            outline: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row p-4 gap-4 overflow-hidden">

    <aside class="w-full md:w-80 soft-glass flex flex-col p-6 z-20">
        <div class="mb-10 px-2 flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-green-600 to-purple-600 flex items-center justify-center font-extrabold text-black">AK</div>
            <div>
                <h1 class="text-xl font-extrabold tracking-tight">CONTROL <span class="text-green-500">AK</span></h1>
                <p class="text-[10px] text-purple-400 font-semibold uppercase tracking-widest opacity-70">Sistema Verificado</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto space-y-2" id="sidebarTabs"></nav>

        <div class="mt-auto pt-6 space-y-3">
            <button onclick="requestNotificationPermission()" id="notifBtn" class="w-full py-3 rounded-2xl text-[10px] font-bold text-amber-400 border border-amber-400/20 hover:bg-amber-400/10 transition-all mb-2">
                HABILITAR ALERTAS NATIVAS
            </button>
            <button onclick="viewFailures()" class="w-full py-3 rounded-2xl text-[11px] font-bold text-red-400 hover:bg-red-500/10 transition-all flex items-center justify-center gap-2">
                REGISTRO DE FALLOS
            </button>
            <button onclick="openNewBoardModal()" class="w-full btn-primary py-4 text-sm shadow-lg">Nuevo Núcleo</button>
        </div>
    </aside>

    <main class="flex-1 soft-glass flex flex-col p-8 md:p-12 relative overflow-hidden">
        <div class="absolute top-[-10%] right-[-10%] w-96 h-96 bg-purple-600/10 rounded-full blur-[120px] pointer-events-none"></div>
        <div id="boardHeader" class="mb-12 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 z-10"></div>
        <div id="boardContent" class="flex-1 flex flex-col z-10 overflow-y-auto"></div>
    </main>

    <!-- Modal Nuevo Núcleo -->
    <div id="newBoardModal" class="fixed inset-0 bg-black/80 backdrop-blur-xl z-50 hidden flex items-center justify-center p-6">
        <div class="soft-glass max-w-md w-full p-10 shadow-2xl bg-neutral-950/90">
            <h3 class="text-xl font-bold mb-8 text-white">Configurar Nuevo Núcleo</h3>
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest mb-3 block">Identificador</label>
                    <input type="text" id="newBoardTitle" placeholder="Nombre del proyecto..." class="w-full px-5 py-4 text-white font-medium">
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="selectMode('goals')" class="mode-btn p-5 card-item text-left group" id="mode-goals">
                        <span class="block font-bold text-white text-sm mb-1 group-hover:text-green-400 transition-colors">Objetivos Binarios</span>
                        <span class="text-xs text-neutral-500">Listas de cumplimiento diario</span>
                    </button>
                    <button onclick="selectMode('limit')" class="mode-btn p-5 card-item text-left group" id="mode-limit">
                        <span class="block font-bold text-white text-sm mb-1 group-hover:text-purple-400 transition-colors">Límites Lógicos</span>
                        <span class="text-xs text-neutral-500">Protocolos SÍ / NO</span>
                    </button>
                </div>
                <div class="flex gap-4 pt-4">
                    <button onclick="closeNewBoardModal()" class="flex-1 py-4 text-neutral-500 font-bold text-xs uppercase hover:text-white transition-colors">Cancelar</button>
                    <button onclick="createNewBoard()" class="flex-1 btn-primary py-4 text-xs uppercase shadow-green-900/20">Inicializar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Fallos -->
    <div id="failuresModal" class="fixed inset-0 bg-black/80 backdrop-blur-xl z-[60] hidden flex items-center justify-center p-6">
        <div class="soft-glass max-w-2xl w-full p-10 shadow-2xl flex flex-col bg-neutral-950/90">
            <div class="flex justify-between items-start mb-8">
                <h3 class="text-2xl font-bold text-white">Anomalías Detectadas</h3>
                <button onclick="closeFailures()" class="p-2 hover:bg-white/5 rounded-full">✕</button>
            </div>
            <div id="failuresList" class="flex-1 overflow-y-auto space-y-4"></div>
        </div>
    </div>

    <script>
        let boards = JSON.parse(localStorage.getItem('ctrl_ak_boards')) || [];
        let failures = JSON.parse(localStorage.getItem('ctrl_ak_failures')) || [];
        let activeBoardId = localStorage.getItem('ctrl_ak_active') || null;
        let selectedMode = 'goals';

        window.onload = () => {
            renderSidebar();
            renderContent();
            updateNotifBtnVisibility();
            startNotificationLoop();
        };

        function save() { 
            localStorage.setItem('ctrl_ak_boards', JSON.stringify(boards));
            localStorage.setItem('ctrl_ak_failures', JSON.stringify(failures));
        }

        // --- SISTEMA DE NOTIFICACIONES ---
        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    updateNotifBtnVisibility();
                    new Notification("Control AK", { body: "Protocolo de alertas activado correctamente." });
                }
            });
        }

        function updateNotifBtnVisibility() {
            const btn = document.getElementById('notifBtn');
            if (Notification.permission === "granted") btn.classList.add('hidden');
        }

        function startNotificationLoop() {
            // Revisa cada minuto si hay alguna notificación pendiente
            setInterval(() => {
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                boards.forEach(board => {
                    if (board.config.notify && board.config.time === currentTime) {
                        // Evita notificaciones repetidas en el mismo minuto
                        if (board.lastNotified !== now.toDateString()) {
                            sendBoardNotification(board);
                            board.lastNotified = now.toDateString();
                            save();
                        }
                    }
                });
            }, 60000);
        }

        function sendBoardNotification(board) {
            new Notification(`Check-in: ${board.title}`, {
                body: "Es hora de revisar tus protocolos de cumplimiento.",
                icon: "https://cdn-icons-png.flaticon.com/512/1160/1160358.png"
            });
        }

        // --- RENDERIZADO Y LÓGICA ---
        function renderSidebar() {
            const container = document.getElementById('sidebarTabs');
            container.innerHTML = boards.map(b => `
                <div class="sidebar-item group px-5 py-4 cursor-pointer flex justify-between items-center ${activeBoardId == b.id ? 'active' : 'hover:bg-white/5 text-neutral-400'}" 
                     onclick="switchBoard(${b.id})">
                    <div class="flex flex-col truncate">
                        <span class="font-bold text-sm truncate">${b.title}</span>
                        <span class="text-[10px] opacity-50 mt-1 uppercase font-semibold">${b.mode}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderContent() {
            const container = document.getElementById('boardContent');
            const header = document.getElementById('boardHeader');
            const board = boards.find(b => b.id == activeBoardId);

            if (!board) {
                container.innerHTML = `<div class="text-center text-neutral-600 mt-20">Selecciona un núcleo</div>`;
                return;
            }

            header.innerHTML = `
                <div>
                    <h2 class="text-4xl font-extrabold text-white">${board.title}</h2>
                    <p class="text-neutral-500 text-xs mt-2 uppercase tracking-widest">${board.mode}</p>
                </div>
                <div class="flex items-center gap-6 p-4 rounded-3xl bg-white/5 border border-white/5">
                    <div class="flex flex-col">
                        <span class="text-[9px] text-neutral-500 font-bold uppercase mb-1">Check-in Programado</span>
                        <input type="time" value="${board.config.time}" onchange="updateConfig(${board.id}, 'time', this.value)"
                               class="bg-transparent text-white font-bold border-none text-xl p-0 focus:ring-0">
                    </div>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" ${board.config.notify ? 'checked' : ''} onchange="updateConfig(${board.id}, 'notify', this.checked)"
                               class="w-6 h-6 rounded-xl border-none bg-neutral-800 text-green-500">
                        <span class="text-[10px] font-bold text-neutral-400 uppercase">Alertas</span>
                    </label>
                </div>
            `;

            container.innerHTML = `<div class="max-w-2xl mx-auto w-full">
                <div class="flex gap-3 mb-10">
                    <input type="text" id="itemAdd" placeholder="Añadir ítem..." class="flex-1 px-6 py-4">
                    <button onclick="addItem(${board.id})" class="btn-primary px-8">Añadir</button>
                </div>
                <ul class="space-y-3">
                    ${(board.mode === 'limit' ? [...board.content.do, ...board.content.dont] : board.content).map(i => `
                        <li class="card-item p-5 flex justify-between items-center group">
                            <div class="flex items-center gap-5 cursor-pointer flex-1" onclick="toggleItem(${board.id}, ${i.id})">
                                <div class="w-6 h-6 rounded-lg border-2 border-neutral-800 flex items-center justify-center ${i.completed ? 'bg-green-500 border-green-500' : ''}">
                                    ${i.completed ? '✓' : ''}
                                </div>
                                <span class="${i.completed ? 'line-through text-neutral-600' : 'text-neutral-200'} text-sm font-semibold">${i.text}</span>
                            </div>
                        </li>
                    `).join('')}
                </ul>
            </div>`;
        }

        function addItem(id) {
            const val = document.getElementById('itemAdd').value;
            if(!val) return;
            const b = boards.find(x=>x.id==id);
            const newItem = {id: Date.now(), text: val, completed: false};
            if(b.mode === 'limit') b.content.do.push(newItem);
            else b.content.push(newItem);
            document.getElementById('itemAdd').value = "";
            save(); renderContent();
        }

        function toggleItem(bid, iid) {
            const b = boards.find(x=>x.id==bid);
            let item;
            if(b.mode === 'limit') item = [...b.content.do, ...b.content.dont].find(x=>x.id==iid);
            else item = b.content.find(x=>x.id==iid);
            item.completed = !item.completed;
            save(); renderContent();
        }

        function switchBoard(id) { activeBoardId = id; localStorage.setItem('ctrl_ak_active', id); renderSidebar(); renderContent(); }
        function openNewBoardModal() { document.getElementById('newBoardModal').classList.remove('hidden'); }
        function closeNewBoardModal() { document.getElementById('newBoardModal').classList.add('hidden'); }
        function selectMode(m) { selectedMode = m; }
        
        function updateConfig(id, k, v) { 
            const b = boards.find(x => x.id == id); 
            b.config[k] = v; 
            if(k === 'time') b.lastNotified = null; // Reiniciar para permitir notificación hoy si cambia la hora
            save(); 
        }

        function createNewBoard() {
            const t = document.getElementById('newBoardTitle').value;
            if(!t) return;
            const nb = { 
                id: Date.now(), title: t, mode: selectedMode, 
                content: selectedMode === 'limit' ? {do:[], dont:[]} : [], 
                config: {notify: true, time: "08:00"},
                lastNotified: null
            };
            boards.push(nb); activeBoardId = nb.id; save(); closeNewBoardModal(); renderSidebar(); renderContent();
        }
    </script>
</body>
</html>