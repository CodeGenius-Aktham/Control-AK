<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control AK: Disciplina Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        :root {
            --bg-deep: #050505;
            --ak-green: #22c55e;
            --ak-purple: #a855f7;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: #e5e7eb;
            letter-spacing: -0.01em;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .soft-glass {
            background: rgba(18, 18, 18, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 2rem;
        }

        .sidebar-item {
            border-radius: 1.25rem;
            transition: all 0.3s ease;
        }

        .sidebar-item.active {
            background: rgba(34, 197, 94, 0.1);
            color: var(--ak-green);
        }

        .btn-primary {
            background: var(--ak-green);
            color: #000;
            border-radius: 1.25rem;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .card-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.5rem;
        }

        input, textarea {
            background: rgba(255, 255, 255, 0.03) !important;
            border-radius: 1rem !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            color: white !important;
        }

        input:focus, textarea:focus {
            border-color: var(--ak-green) !important;
            outline: none;
        }

        .mono-timer {
            font-family: 'Courier New', Courier, monospace;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            main { min-height: 100vh; margin-top: 10px; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row gap-4 p-4">

    <!-- Sidebar -->
    <aside class="w-full md:w-80 soft-glass flex flex-col p-6 shrink-0 h-fit md:h-auto">
        <div class="mb-8 px-2 flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-green-600 to-purple-600 flex items-center justify-center font-extrabold text-black text-xs">AK</div>
            <h1 class="text-xl font-extrabold tracking-tight">CONTROL <span class="text-green-500">AK</span></h1>
        </div>

        <nav class="flex-1 space-y-2 mb-6" id="sidebarTabs"></nav>

        <div class="space-y-3">
            <button onclick="viewFailures()" class="w-full py-3 rounded-2xl text-[11px] font-bold text-red-400 border border-red-500/10">HISTORIAL DE FALLOS</button>
            <button onclick="openNewBoardModal()" class="w-full btn-primary py-4 text-sm">Nuevo Núcleo</button>
        </div>
    </aside>

    <!-- Main Workspace -->
    <main class="flex-1 soft-glass flex flex-col p-6 md:p-10 relative">
        <div id="boardHeader" class="mb-8 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 z-10"></div>
        <div id="boardContent" class="flex-1 z-10 flex flex-col"></div>
    </main>

    <!-- Modales -->
    <div id="newBoardModal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-6">
        <div class="soft-glass max-w-md w-full p-8 bg-neutral-950">
            <h3 class="text-xl font-bold mb-6 text-white">Configurar Núcleo</h3>
            <input type="text" id="newBoardTitle" placeholder="Nombre del proyecto..." class="w-full px-5 py-4 mb-4">
            <div class="grid gap-2 mb-6">
                <button onclick="selectMode('basic')" class="mode-btn p-4 card-item text-left text-sm" id="mode-basic">
                    <span class="block font-bold">Notas Libres</span>
                    <span class="text-[10px] opacity-50">Escritura y bitácora</span>
                </button>
                <button onclick="selectMode('goals')" class="mode-btn p-4 card-item text-left text-sm" id="mode-goals">
                    <span class="block font-bold">Objetivos Binarios</span>
                    <span class="text-[10px] opacity-50">Listas de tareas</span>
                </button>
                <button onclick="selectMode('limit')" class="mode-btn p-4 card-item text-left text-sm" id="mode-limit">
                    <span class="block font-bold">Límites Lógicos</span>
                    <span class="text-[10px] opacity-50">Reglas SÍ / NO</span>
                </button>
            </div>
            <div class="flex gap-4">
                <button onclick="closeNewBoardModal()" class="flex-1 text-xs font-bold opacity-50">CERRAR</button>
                <button onclick="createNewBoard()" class="flex-1 btn-primary py-4 text-xs">INICIALIZAR</button>
            </div>
        </div>
    </div>

    <div id="failuresModal" class="fixed inset-0 bg-black/95 z-[60] hidden flex items-center justify-center p-4">
        <div class="soft-glass max-w-2xl w-full p-8 flex flex-col max-h-[90vh]">
            <h3 class="text-2xl font-bold mb-6">Fallas de Integridad</h3>
            <div id="failuresList" class="flex-1 overflow-y-auto space-y-4"></div>
            <button onclick="closeFailures()" class="mt-6 btn-primary py-4">CERRAR</button>
        </div>
    </div>

    <script>
        let boards = JSON.parse(localStorage.getItem('ctrl_ak_boards')) || [];
        let failures = JSON.parse(localStorage.getItem('ctrl_ak_failures')) || [];
        let activeBoardId = localStorage.getItem('ctrl_ak_active') || null;
        let selectedMode = 'basic';
        let cronInterval;

        window.onload = () => {
            renderSidebar();
            renderContent();
        };

        function save() {
            localStorage.setItem('ctrl_ak_boards', JSON.stringify(boards));
            localStorage.setItem('ctrl_ak_failures', JSON.stringify(failures));
        }

        // --- CRONÓMETRO MEJORADO (CON MS) ---
        function formatTime(ms) {
            const totalSecs = Math.floor(ms / 1000);
            const h = Math.floor(totalSecs / 3600);
            const m = Math.floor((totalSecs % 3600) / 60);
            const s = totalSecs % 60;
            const milli = Math.floor((ms % 1000) / 10); // Mostramos solo 2 dígitos de ms

            const parts = [];
            if (h > 0) parts.push(h.toString().padStart(2, '0'));
            parts.push(m.toString().padStart(2, '0'));
            parts.push(s.toString().padStart(2, '0'));
            
            return `${parts.join(':')}<span class="text-xs opacity-50 ml-1">.${milli.toString().padStart(2, '0')}</span>`;
        }

        function toggleCron(id) {
            const b = boards.find(x => x.id == id);
            if (!b.cron) b.cron = { active: false, elapsed: 0, lastStart: 0 };

            if (!b.cron.active) {
                b.cron.active = true;
                b.cron.lastStart = Date.now();
                runCron(id);
            } else {
                b.cron.active = false;
                b.cron.elapsed += Date.now() - b.cron.lastStart;
                if (cronInterval) clearInterval(cronInterval);
            }
            save();
            renderContent();
        }

        function runCron(id) {
            if (cronInterval) clearInterval(cronInterval);
            // Usamos un intervalo más corto (40ms aprox 25fps) para fluidez de milisegundos
            cronInterval = setInterval(() => {
                const b = boards.find(x => x.id == id);
                if (!b || !b.cron || !b.cron.active) { 
                    clearInterval(cronInterval); 
                    return; 
                }

                const totalMs = b.cron.elapsed + (Date.now() - b.cron.lastStart);
                const display = document.getElementById('timerDisplay');
                if (display) {
                    display.innerHTML = formatTime(totalMs);
                }
            }, 40);
        }

        function resetCron(id) {
            const b = boards.find(x => x.id == id);
            b.cron = { active: false, elapsed: 0, lastStart: 0 };
            if (cronInterval) clearInterval(cronInterval);
            save();
            renderContent();
        }

        // --- RENDERING ---
        function renderSidebar() {
            const container = document.getElementById('sidebarTabs');
            container.innerHTML = boards.map(b => `
                <div class="sidebar-item p-4 cursor-pointer flex flex-col ${activeBoardId == b.id ? 'active' : 'text-neutral-500 hover:bg-white/5'}" onclick="switchBoard(${b.id})">
                    <span class="font-bold text-sm truncate">${b.title}</span>
                    <span class="text-[9px] opacity-50 uppercase tracking-widest">${b.mode === 'basic' ? 'Notas' : b.mode}</span>
                </div>
            `).join('');
        }

        function renderContent() {
            const container = document.getElementById('boardContent');
            const header = document.getElementById('boardHeader');
            const b = boards.find(x => x.id == activeBoardId);

            if (!b) {
                header.innerHTML = "";
                container.innerHTML = `<div class="mt-20 text-center opacity-30 text-sm font-bold uppercase tracking-[0.2em]">Seleccionar Núcleo</div>`;
                return;
            }

            if (!b.cron) b.cron = { active: false, elapsed: 0, lastStart: 0 };

            const currentTotal = b.cron.active ? (b.cron.elapsed + (Date.now() - b.cron.lastStart)) : b.cron.elapsed;

            header.innerHTML = `
                <div class="flex-1">
                    <h2 class="text-3xl font-black text-white">${b.title}</h2>
                    <p class="text-[10px] text-neutral-500 uppercase font-bold tracking-widest mt-1">Modo: ${b.mode}</p>
                </div>
                <div class="flex items-center gap-4 p-4 card-item bg-white/5 border-white/10">
                    <div class="text-left min-w-[100px]">
                        <span class="block text-[8px] text-neutral-500 uppercase font-bold mb-1">Enfoque AK</span>
                        <span id="timerDisplay" class="text-2xl font-black mono-timer ${b.cron.active ? 'text-green-500' : 'text-neutral-400'}">
                            ${formatTime(currentTotal)}
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleCron(${b.id})" class="${b.cron.active ? 'bg-red-500 text-black' : 'bg-green-500 text-black'} px-5 py-2 rounded-xl text-[10px] font-black uppercase transition-all transform active:scale-95 shadow-lg ${b.cron.active ? 'shadow-red-500/20' : 'shadow-green-500/20'}">
                            ${b.cron.active ? 'STOP' : 'START'}
                        </button>
                        <button onclick="resetCron(${b.id})" class="bg-white/5 text-white/40 hover:text-white/80 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">Reset</button>
                    </div>
                </div>
            `;

            if (b.cron.active) runCron(b.id);

            if (b.mode === 'basic') {
                container.innerHTML = `<textarea oninput="updateBasic(${b.id}, this.value)" class="flex-1 w-full min-h-[400px] p-6 text-neutral-300 leading-relaxed resize-none border-none bg-transparent" placeholder="Escribe tu bitácora de hoy...">${b.content || ''}</textarea>`;
            } else if (b.mode === 'goals') {
                container.innerHTML = `
                    <div class="max-w-xl mx-auto w-full">
                        <div class="flex gap-2 mb-8">
                            <input type="text" id="goalAdd" placeholder="Nueva meta..." class="flex-1 p-4 text-sm">
                            <button onclick="addItem(${b.id})" class="btn-primary px-6 text-xl">+</button>
                        </div>
                        <ul class="space-y-3">${b.content.map(i => renderItem(b.id, i)).join('')}</ul>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="flex flex-col gap-10">
                        <section>
                            <h3 class="text-green-500 text-[10px] font-bold uppercase mb-4 tracking-widest">Compromisos (SÍ)</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="doAdd" placeholder="Añadir compromiso..." class="flex-1 p-3 text-sm">
                                <button onclick="addLimit(${b.id}, 'do')" class="px-4 card-item font-bold text-green-500">+</button>
                            </div>
                            <ul class="space-y-2">${b.content.do.map(i => renderItem(b.id, i, 'do')).join('')}</ul>
                        </section>
                        <section class="pb-20">
                            <h3 class="text-purple-500 text-[10px] font-bold uppercase mb-4 tracking-widest">Restricciones (NO)</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="dontAdd" placeholder="Añadir límite..." class="flex-1 p-3 text-sm">
                                <button onclick="addLimit(${b.id}, 'dont')" class="px-4 card-item font-bold text-purple-500">+</button>
                            </div>
                            <ul class="space-y-2">${b.content.dont.map(i => renderItem(b.id, i, 'dont')).join('')}</ul>
                        </section>
                    </div>
                `;
            }
        }

        function renderItem(bid, i, type = null) {
            return `
                <li class="card-item p-4 flex justify-between items-center">
                    <div class="flex items-center gap-4 flex-1 cursor-pointer" onclick="toggleItem(${bid}, ${i.id}, '${type}')">
                        <div class="w-6 h-6 rounded-lg border border-neutral-700 flex items-center justify-center transition-colors ${i.completed ? 'bg-green-500 border-green-500' : ''}">
                            ${i.completed ? '<span class="text-black font-bold text-xs">✓</span>' : ''}
                        </div>
                        <span class="text-sm font-medium ${i.completed ? 'line-through opacity-30' : ''}">${i.text}</span>
                    </div>
                    <button onclick="deleteItem(${bid}, ${i.id}, '${type}')" class="text-neutral-700 hover:text-red-500 px-2">✕</button>
                </li>
            `;
        }

        function switchBoard(id) { 
            activeBoardId = id; 
            localStorage.setItem('ctrl_ak_active', id); 
            if (cronInterval) clearInterval(cronInterval);
            renderSidebar(); 
            renderContent(); 
        }

        function openNewBoardModal() { document.getElementById('newBoardModal').classList.remove('hidden'); }
        function closeNewBoardModal() { document.getElementById('newBoardModal').classList.add('hidden'); }
        function selectMode(m) { selectedMode = m; document.querySelectorAll('.mode-btn').forEach(btn => btn.style.borderColor = btn.id === `mode-${m}` ? '#22c55e' : ''); }
        
        function createNewBoard() {
            const t = document.getElementById('newBoardTitle').value;
            if(!t) return;
            const nb = { 
                id: Date.now(), 
                title: t, 
                mode: selectedMode, 
                content: selectedMode === 'limit' ? {do:[], dont:[]} : (selectedMode === 'basic' ? '' : []),
                cron: { active: false, elapsed: 0, lastStart: 0 }
            };
            boards.push(nb); activeBoardId = nb.id; save(); closeNewBoardModal(); renderSidebar(); renderContent();
        }

        function updateBasic(id, val) { boards.find(x => x.id == id).content = val; save(); }

        function addItem(id) {
            const input = document.getElementById('goalAdd');
            if(!input.value) return;
            boards.find(x => x.id == id).content.push({id: Date.now(), text: input.value, completed: false});
            input.value = ''; save(); renderContent();
        }

        function addLimit(id, type) {
            const input = document.getElementById(`${type}Add`);
            if(!input.value) return;
            boards.find(x => x.id == id).content[type].push({id: Date.now(), text: input.value, completed: false});
            input.value = ''; save(); renderContent();
        }

        function toggleItem(bid, iid, type) {
            const b = boards.find(x => x.id == bid);
            const list = (type && type !== 'null') ? b.content[type] : b.content;
            const item = list.find(x => x.id == iid);
            item.completed = !item.completed;
            save(); renderContent();
        }

        function deleteItem(bid, iid, type) {
            const b = boards.find(x => x.id == bid);
            if (type && type !== 'null') b.content[type] = b.content[type].filter(x => x.id != iid);
            else b.content = b.content.filter(x => x.id != iid);
            save(); renderContent();
        }

        function viewFailures() { document.getElementById('failuresModal').classList.remove('hidden'); }
        function closeFailures() { document.getElementById('failuresModal').classList.add('hidden'); }
    </script>
</body>
</html>